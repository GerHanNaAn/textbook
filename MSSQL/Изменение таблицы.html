<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h2>Изменение таблицы</h2>
    <p>Возможно, в какой-то момент мы захотим изменить уже имеющуюся таблицу. Например, добавить или удалить столбцы, изменить тип столбцов, добавить или удалить ограничения. 
        То есть потребуется изменить определение таблицы. Для изменения таблиц используется выражение <span class="b">ALTER TABLE</span>.</p>
        <p>Общий формальный синтаксис команды выглядит следующим образом:</p>
<div><div id="highlighter_573937" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">название_таблицы [</code><code class="sql keyword">WITH</code> <code class="sql keyword">CHECK</code> <code class="sql plain">| </code><code class="sql keyword">WITH</code> <code class="sql plain">NOCHECK]</code></div><div class="line number2 index1 alt1"><code class="sql plain">{ </code><code class="sql keyword">ADD</code> <code class="sql plain">название_столбца тип_данных_столбца [атрибуты_столбца] | </code></div><div class="line number3 index2 alt2"><code class="sql spaces">&nbsp;&nbsp;</code><code class="sql keyword">DROP</code> <code class="sql keyword">COLUMN</code> <code class="sql plain">название_столбца |</code></div><div class="line number4 index3 alt1"><code class="sql spaces">&nbsp;&nbsp;</code><code class="sql keyword">ALTER</code> <code class="sql keyword">COLUMN</code> <code class="sql plain">название_столбца тип_данных_столбца [</code><code class="sql color1">NULL</code><code class="sql plain">|</code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code><code class="sql plain">] |</code></div><div class="line number5 index4 alt2"><code class="sql spaces">&nbsp;&nbsp;</code><code class="sql keyword">ADD</code> <code class="sql plain">[</code><code class="sql keyword">CONSTRAINT</code><code class="sql plain">] определение_ограничения |</code></div><div class="line number6 index5 alt1"><code class="sql spaces">&nbsp;&nbsp;</code><code class="sql keyword">DROP</code> <code class="sql plain">[</code><code class="sql keyword">CONSTRAINT</code><code class="sql plain">] имя_ограничения}</code></div></div></td></tr></tbody></table></div></div>


<p>Таким образом, с помощью <code>ALTER TABLE</code> мы можем провернуть самые различные сценарии изменения таблицы. Рассмотрим некоторые из них.</p>


<h3>Добавление нового столбца</h3>

<p>Добавим в таблицу Customers новый столбец Address:</p>
<div><div id="highlighter_68700" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ADD</code> <code class="sql plain">Address NVARCHAR(50) </code><code class="sql color1">NULL</code><code class="sql plain">;</code></div></div></td></tr></tbody></table></div></div>
<p>В данном случае столбец Address имеет тип NVARCHAR и для него определен атрибут NULL. Но что если нам надо добавить столбец, который не должен принимать 
    значения NULL? Если в таблице есть данные, то следующая команда не будет выполнена:</p>
    <div><div id="highlighter_699362" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ADD</code> <code class="sql plain">Address NVARCHAR(50) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code><code class="sql plain">;</code></div></div></td></tr></tbody></table></div></div>
    <p>Поэтому в данном случае решение состоит в установке значения по умолчанию через атрибут DEFAULT:</p>
    <div><div id="highlighter_27622" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ADD</code> <code class="sql plain">Address NVARCHAR(50) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code> <code class="sql keyword">DEFAULT</code> <code class="sql string">'Неизвестно'</code><code class="sql plain">;</code></div></div></td></tr></tbody></table></div></div>

    <div><div id="highlighter_27622" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ADD</code> <code class="sql plain">Address NVARCHAR(50) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code> <code class="sql keyword">DEFAULT</code> <code class="sql string">'Неизвестно'</code><code class="sql plain">;</code></div></div></td></tr></tbody></table></div></div>
    <h3>Удаление столбца</h3>
    <div><div id="highlighter_692240" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers</code></div><div class="line number2 index1 alt1"><code class="sql keyword">DROP</code> <code class="sql keyword">COLUMN</code> <code class="sql plain">Address;</code></div></div></td></tr></tbody></table></div></div>

    <h3>Изменение типа столбца</h3>
    <p>Изменим в таблице Customers тип данных у столбца FirstName на <code>NVARCHAR(200)</code>:</p>
    <div><div id="highlighter_117989" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ALTER</code> <code class="sql keyword">COLUMN</code> <code class="sql plain">FirstName NVARCHAR(200);</code></div></div></td></tr></tbody></table></div></div>

    <h3>Добавление ограничения CHECK</h3>
    <p>При добавлении ограничений SQL Server автоматически проверяет имеющиеся данные на соответствие добавляемым ограничениям. Если данные не соответствуют 
        ограничениям, то такие ограничения не будут добавлены. Например, установим для столбца Age в таблице Customers ограничение Age &gt; 21.</p>

        <div><div id="highlighter_798847" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ADD</code> <code class="sql keyword">CHECK</code> <code class="sql plain">(Age &gt; 21);</code></div></div></td></tr></tbody></table></div></div>

        <p>Если в таблице есть строки, в которых в столбце Age есть значения, несоответствующие этому ограничению, то sql-команда завершится с ошибкой. 
            Чтобы избежать подобной проверки на соответствие и все таки добавить ограничение, несмотря на наличие несоответствующих ему данных, 
            используется выражение <span class="b">WITH NOCHECK</span>:</p>
            <div><div id="highlighter_26683" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers </code><code class="sql keyword">WITH</code> <code class="sql plain">NOCHECK</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ADD</code> <code class="sql keyword">CHECK</code> <code class="sql plain">(Age &gt; 21);</code></div></div></td></tr></tbody></table></div></div>

            <p>По умолчанию используется значение <span class="b">WITH CHECK</span>, которое проверяет на соответствие ограничениям.</p>

            <h3>Добавление внешнего ключа</h3>

            <p>Пусть изначально в базе данных будут добавлены две таблицы, никак не связанные:</p>
<div><div id="highlighter_518124" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">CREATE</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers</code></div><div class="line number2 index1 alt1"><code class="sql plain">(</code></div><div class="line number3 index2 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">Id </code><code class="sql keyword">INT</code> <code class="sql keyword">PRIMARY</code> <code class="sql keyword">KEY</code> <code class="sql plain">IDENTITY,</code></div><div class="line number4 index3 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">Age </code><code class="sql keyword">INT</code> <code class="sql keyword">DEFAULT</code> <code class="sql plain">18, </code></div><div class="line number5 index4 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">FirstName NVARCHAR(20) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code><code class="sql plain">,</code></div><div class="line number6 index5 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">LastName NVARCHAR(20) </code><code class="sql color1">NOT</code> <code class="sql color1">NULL</code><code class="sql plain">,</code></div><div class="line number7 index6 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">Email </code><code class="sql keyword">VARCHAR</code><code class="sql plain">(30) </code><code class="sql keyword">UNIQUE</code><code class="sql plain">,</code></div><div class="line number8 index7 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">Phone </code><code class="sql keyword">VARCHAR</code><code class="sql plain">(20) </code><code class="sql keyword">UNIQUE</code></div><div class="line number9 index8 alt2"><code class="sql plain">);</code></div><div class="line number10 index9 alt1"><code class="sql keyword">CREATE</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Orders</code></div><div class="line number11 index10 alt2"><code class="sql plain">(</code></div><div class="line number12 index11 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">Id </code><code class="sql keyword">INT</code> <code class="sql plain">IDENTITY,</code></div><div class="line number13 index12 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">CustomerId </code><code class="sql keyword">INT</code><code class="sql plain">,</code></div><div class="line number14 index13 alt1"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql plain">CreatedAt </code><code class="sql keyword">Date</code></div><div class="line number15 index14 alt2"><code class="sql plain">);</code></div></div></td></tr></tbody></table></div></div>
<p>Добавим ограничение внешнего ключа к столбцу CustomerId таблицы Orders:</p>
<div><div id="highlighter_34828" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Orders</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ADD</code> <code class="sql keyword">FOREIGN</code> <code class="sql keyword">KEY</code><code class="sql plain">(CustomerId) </code><code class="sql keyword">REFERENCES</code> <code class="sql plain">Customers(Id);</code></div></div></td></tr></tbody></table></div></div>
<h3>Добавление первичного ключа</h3>
<p>Используя выше определенную таблицу Orders, добавим к ней первичный ключ для столбца Id:</p>
<div><div id="highlighter_337939" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Orders</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ADD</code> <code class="sql keyword">PRIMARY</code> <code class="sql keyword">KEY</code> <code class="sql plain">(Id);</code></div></div></td></tr></tbody></table></div></div>
<h3>Добавление ограничений с именами</h3>
<p>При добавлении ограничений мы можем указать для них имя, используя оператор <span class="b">CONSTRAINT</span>, после которого указывается имя ограничения:</p>

<div><div id="highlighter_924314" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Orders</code></div><div class="line number2 index1 alt1"><code class="sql keyword">ADD</code> <code class="sql keyword">CONSTRAINT</code> <code class="sql plain">PK_Orders_Id </code><code class="sql keyword">PRIMARY</code> <code class="sql keyword">KEY</code> <code class="sql plain">(Id),</code></div><div class="line number3 index2 alt2"><code class="sql spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="sql keyword">CONSTRAINT</code> <code class="sql plain">FK_Orders_To_Customers </code><code class="sql keyword">FOREIGN</code> <code class="sql keyword">KEY</code><code class="sql plain">(CustomerId) </code><code class="sql keyword">REFERENCES</code> <code class="sql plain">Customers(Id);</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Customers</code></div><div class="line number6 index5 alt1"><code class="sql keyword">ADD</code> <code class="sql keyword">CONSTRAINT</code> <code class="sql plain">CK_Age_Greater_Than_Zero </code><code class="sql keyword">CHECK</code> <code class="sql plain">(Age &gt; 0);</code></div></div></td></tr></tbody></table></div></div>

<h3>Удаление ограничений</h3>

<p>Для удаления ограничений необходимо знать их имя. Если мы точно не знаем имя ограничения, то его можно узнать через SQL Server Management Studio:</p>
<img src="pics/34.png" alt="Изменение таблиц и ALTER TABLE в MS SQL Server 2016">
<p>Раскрыв узел таблиц в подузле Keys можно увидеть названия ограничений первичного и внешних ключей. Названия ограничений внешних ключей 
    начинаются с "FK". А в подузле Constraints можно найти все ограничения CHECK и DEFAULT. Названия ограничений CHECK начинаются с "CK", 
    а ограничений DEFAULT - с "DF".</p>
    <p>Например, как видно на скриншоте в моем случае имя ограничения внешнего ключа в таблице Orders называется "FK_Orders_To_Customers". 
        Поэтому для удаления внешнего ключа я могу использовать следующее выражение:</p>
        <div><div id="highlighter_126821" class="syntaxhighlighter  sql"><div class="toolbar"><span>  </span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="sql keyword">ALTER</code> <code class="sql keyword">TABLE</code> <code class="sql plain">Orders</code></div><div class="line number2 index1 alt1"><code class="sql keyword">DROP</code> <code class="sql plain">FK_Orders_To_Customers;</code></div></div></td></tr></tbody></table></div></div>



</body>
</html>